<!-- personal_account.html (SECURE) -->
<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoBreak - Личный кабинет</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>
    <!-- Header -->
    <header>
        <a href="index.html" id="logo-link" class="active">
            <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
        </a>
        <nav>
            <ul>
                <space></space>
                <li><a href="about.html">О нас</a></li>
                <li><a href="projects.html">Проекты</a></li>
                <li><a href="fanfics.html">Комьюнити</a></li>
                <li><a href="crypto.html">Крипта</a></li>
            </ul>
        </nav>
    </header>
    <div class="separator"></div>
    <main>
        <div class="tab-content">
            <div id="profile-tab" class="tab-pane active">
                <h2>Загрузка...</h2>
                <div class="avatar-container">
                    <div class="button-group">
                        <button class="transparent-button" id="addPhotoButton">Добавить фото</button>
                    </div>
                    <div class="avatar">
                        <img src="images/avatar-placeholder.png" id="user-avatar" class="circular-avatar">
                    </div>
                </div>
                <div class="user-info">
                    <left-label>Ник:</left-label>
                    <div class="rounded-rectangle">
                        <p id="nameField">—</p>
                    </div>
                    <left-label>Ключ активации:</left-label>
                    <div class="rounded-rectangle">
                        <p id="activationKeyField">—</p>
                    </div>
                </div>
                <div class="buttons-container">
                    <button class="transparent-button" id="changePasswordButton">Сменить пароль</button>
                    <button class="button" id="logoutButton">Выйти</button>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>EchoBreak, 2025</p>
    </footer>
    <script>
        const API_BASE = 'https://EchoBreakStatus.pythonanywhere.com';

        document.addEventListener('DOMContentLoaded', async function () {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const name = localStorage.getItem('userName');
            if (!isLoggedIn || !name) {
                document.querySelector('main').innerHTML = `
                    <h2>Вы не вошли в аккаунт</h2>
                    <button class="button" onclick="location.href='login.html'">Войти</button>`;
                return;
            }

            try {
                // Load user data
                const userDataResp = await fetch(`${API_BASE}/api/user-data?name=${encodeURIComponent(name)}`);
                if (!userDataResp.ok) {
                    throw new Error('Пользователь не найден');
                }
                const { user_data: userData, profile_pic_url: profilePicUrl } = await userDataResp.json();

                // Set role
                const token = (userData.userToken || '').trim();
                const roleMap = {
                    'UR': 'Пользователь', 'UA': 'Автор', 'UD': 'Иллюстратор',
                    'AD': 'Разработчик', 'AW': 'WEB-дизайнер', 'AT': 'Тестировщик'
                };
                let role = 'Непотверждён';
                for (const [prefix, label] of Object.entries(roleMap)) {
                    if (token.startsWith(prefix)) { role = label; break; }
                }
                document.querySelector('#profile-tab h2').textContent = role;
                document.getElementById('nameField').textContent = userData.name || name;

                // Load avatar
                if (profilePicUrl) {
                    const imgResp = await fetch(profilePicUrl);
                    if (imgResp.ok) {
                        const imgText = await imgResp.text();
                        document.getElementById('user-avatar').src = imgText;
                    }
                }

                // Handle activation key
                const keyField = document.getElementById('activationKeyField');
                if (!token) {
                    keyField.innerHTML = `
                        <input type="text" id="keyInput" placeholder="Введите ключ">
                        <button id="verifyBtn">✓</button>`;
                    document.getElementById('verifyBtn').onclick = () => verifyKey(name, userData);
                } else if (token === 'rejected') {
                    keyField.innerHTML = `<p style="color:#d25354;">Отклонён</p>`;
                } else {
                    keyField.textContent = token;
                }

                // Buttons
                document.getElementById('logoutButton').onclick = () => {
                    localStorage.clear();
                    location.href = 'index.html';
                };
                document.getElementById('changePasswordButton').onclick = () => {
                    location.href = 'change_password.html';
                };

                // Avatar upload
                document.getElementById('addPhotoButton').onclick = () => uploadAvatar(name);

            } catch (err) {
                document.querySelector('main').innerHTML = `
                    <h2>Ошибка: ${err.message}</h2>
                    <button class="button" onclick="location.href='login.html'">Войти</button>`;
            }
        });

        async function verifyKey(name, userData) {
            const input = document.getElementById('keyInput');
            if (!input) return;
            const key = input.value.trim();
            if (!key) return alert('Введите ключ');

            try {
                const resp = await fetch(`${API_BASE}/api/verify-key`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, key })
                });
                const result = await resp.json();
                if (resp.ok) {
                    alert('Ключ успешно активирован!');
                    location.reload();
                } else {
                    alert('Ошибка: ' + (result.error || 'неверный ключ'));
                }
            } catch (e) {
                alert('Ошибка подключения');
            }
        }

        async function uploadAvatar(name) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (ev) => {
                    // Process image (crop, resize, circle) — simplified: send as base64
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const size = Math.min(img.width, img.height);
                        canvas.width = canvas.height = 128;
                        ctx.drawImage(img, (img.width - size) / 2, (img.height - size) / 2, size, size, 0, 0, 128, 128);
                        // Circle mask
                        ctx.globalCompositeOperation = 'destination-in';
                        ctx.beginPath();
                        ctx.arc(64, 64, 64, 0, Math.PI * 2);
                        ctx.fill();
                        const base64 = canvas.toDataURL('image/png');

                        // Send to backend
                        const resp = await fetch(`${API_BASE}/api/update-user-data`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name,
                                avatar_base64: base64
                            })
                        });
                        if (resp.ok) {
                            document.getElementById('user-avatar').src = base64;
                        } else {
                            alert('Ошибка загрузки аватара');
                        }
                    };
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }
    </script>
</body>

</html>