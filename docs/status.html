<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoBreak - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <style>
    /* Optional: Add minimal styles if not in style.css */
    /*
    .device-box {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .status-ok { color: green; font-weight: bold; }
    .status-error { color: red; font-weight: bold; }
    #refresh-time { font-size: 0.9em; color: #666; margin-top: 10px; }
    */
  </style>
</head>

<body>

  <!-- Header -->
  <header>
    <a href="index.html" id="logo-link">
      <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
    </a>
    <nav>
      <ul>
        <space></space>
        <li><a href="about.html">О нас</a></li>
        <li><a href="projects.html" class="active">Проекты</a></li>
        <li><a href="fanfics.html">Комьюнити</a></li>
        <li><a href="crypto.html">Крипта</a></li>
      </ul>
    </nav>
  </header>

  <!-- Separator Line -->
  <div class="separator"></div>

  <!-- Main Content -->
  <main>
    <h1>EchoBreak</h1>
    <h2>Device Status Dashboard</h2>
    <div id="dashboard">Загрузка устройств...</div>
    <div id="refresh-time"></div>
  </main>

  <!-- Footer -->
  <footer>
    <p>EchoBreak, 2025</p>
  </footer>

  <script>
    const SERVER_URL = 'https://EchoBreakStatus.pythonanywhere.com/api/status';
    const REFRESH_INTERVAL = 30000;

    const dashboard = document.getElementById('dashboard');
    const refreshTimeEl = document.getElementById('refresh-time');

    async function fetchStatus() {
      try {
        dashboard.innerHTML = 'Обновление данных...';
        const res = await fetch(SERVER_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);
        
        const devices = await res.json();
        renderDevices(devices);
        refreshTimeEl.textContent = 'Последнее обновление: ' + new Date().toLocaleString('ru-RU');
      } catch (error) {
        console.error('Ошибка:', error);
        dashboard.innerHTML = `<p class="status-error">Ошибка загрузки: ${error.message}</p>`;
      }
    }

    function renderDevices(devices) {
      if (!devices || Object.keys(devices).length === 0) {
        dashboard.innerHTML = '<p>Нет данных о статусе устройств.</p>';
        return;
      }

      let content = '';
      for (const [hostname, data] of Object.entries(devices)) {
        const displayStatus = data.status || 'N/A';
        const displayXMRig = data.xmrig_status || 'N/A';
        const statusClass = displayStatus === 'online' ? 'status-ok' : 'status-error';
        const lastSeen = data.last_seen ? new Date(data.last_seen).toLocaleString('ru-RU') : 'неизвестно';

        content += `
          <div class="device-box">
            <h3>${data.hostname || hostname}</h3>
            <p><strong>Статус:</strong> <span class="${statusClass}">${displayStatus}</span></p>
            <p><strong>XMRig:</strong> ${displayXMRig}</p>
            <p><small>Обновлено: ${lastSeen}</small></p>
          </div>
        `;
      }

      dashboard.innerHTML = content;
    }

    fetchStatus();

    setInterval(fetchStatus, REFRESH_INTERVAL);
  </script>
</body>

</html>