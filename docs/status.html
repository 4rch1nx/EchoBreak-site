<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoBreak - Status</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>
<body>

  <!-- Header -->
  <header>
    <a href="index.html" id="logo-link">
      <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
    </a>
    <nav>
      <ul>
        <space></space>
        <li><a href="about.html">О нас</a></li>
        <li><a href="projects.html" class="active">Проекты</a></li>
        <li><a href="fanfics.html">Комьюнити</a></li>
        <li><a href="crypto.html">Крипта</a></li>
      </ul>
    </nav>
  </header>

  <!-- Separator Line -->
  <div class="separator"></div>

  <!-- Main Content -->
  <main>
    <h1>EchoBreak</h1>
    <h2>Device Status Dashboard</h2>
    <div id="dashboard">Загрузка устройств...</div>
  </main>

  <!-- Footer -->
  <footer>
    <p>EchoBreak, 2025</p>
  </footer>

  <script>
    const GIST_ID = 'f115340ff9260344597ae98580b36e15';

    async function loadStatusFiles() {
      const dashboard = document.getElementById('dashboard');

      try {
        const response = await fetch(`https://api.github.com/gists/${GIST_ID}`);

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`HTTP ${response.status}: ${error}`);
        }

        const gist = await response.json();

        const statusFiles = Object.keys(gist.files)
          .filter(filename => filename.startsWith('status') && filename.endsWith('.json'));

        if (statusFiles.length === 0) {
          dashboard.innerHTML = '<p>Файлы статуса не найдены (ожидаются: status*.json).</p>';
          return;
        }

        dashboard.innerHTML = '';

        for (const filename of statusFiles) {
          const file = gist.files[filename];
          try {
            const fileRes = await fetch(file.raw_url);
            if (!fileRes.ok) throw new Error(`Не удалось загрузить ${filename}`);

            const data = await fileRes.json();

            const box = document.createElement('div');
            box.className = 'device-box';

            const deviceName = data.name || filename.replace('.json', '');
            const statusClass = data.status === 'online' ? 'status-ok' :
                               data.status === 'offline' ? 'status-error' : 'status-warning';

            box.innerHTML = `
              <h3>${deviceName}</h3>
              <p><strong>Статус:</strong> <span class="${statusClass}">${data.status || 'N/A'}</span></p>
              <p><strong>XMRig:</strong> ${data['xmrig-status'] || 'N/A'}</p>
              ${data.error ? `<p><strong>Ошибка:</strong> <span class="status-error">${data.error}</span></p>` : ''}
            `;

            dashboard.appendChild(box);
          } catch (err) {
            console.error(`Ошибка при загрузке ${filename}:`, err);
            const box = document.createElement('div');
            box.className = 'device-box';
            box.innerHTML = `<h3>${filename}</h3><p class="status-error">Ошибка: не удалось прочитать данные.</p>`;
            dashboard.appendChild(box);
          }
        }

      } catch (err) {
        console.error('Критическая ошибка:', err);
        dashboard.innerHTML = `
          <p><strong>Ошибка загрузки данных:</strong> ${err.message}</p>
          <p>Проверьте:</p>
          <ul>
            <li>Правильный GIST_ID</li>
            <li>Gist публичный</li>
            <li>Вы используете сервер (не file://)</li>
          </ul>
        `;
      }
    }

    window.onload = loadStatusFiles;
  </script>
</body>
</html>