<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoBreak - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>

  <!-- Header -->
  <header>
    <a href="index.html" id="logo-link">
      <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
    </a>
    <nav>
      <ul>
        <li><a href="about.html">О нас</a></li>
        <li><a href="projects.html" class="active">Проекты</a></li>
        <li><a href="fanfics.html">Комьюнити</a></li>
        <li><a href="crypto.html">Крипта</a></li>
        <li>
          <a href="personal_account.html" class="account-icon">
            <img src="images/avatar-placeholder.png" alt="Аккаунт">
          </a>
        </li>
      </ul>
    </nav>
  </header>

  <!-- Separator Line -->
  <div class="separator"></div>

  <!-- Main Content -->
  <main>
    <h1>EchoBreak</h1>
    <h2>Device Status Dashboard</h2>

    <div class="status-line">
      <span class="online-status">Онлайн:</span>
      <span class="total-count" id="online-count">0/0</span>
    </div>
    <div class="status-line">
      <span class="xmrig-status">XMRig запущено:</span>
      <span class="total-count" id="xmrig-count">0/0</span>
    </div>
    <div id="refresh-time"></div>

    <div id="dashboard">Загрузка устройств...</div>
  </main>

  <!-- Footer -->
  <footer>
    <p>EchoBreak © 2025-2026</p>
  </footer>

  <script>
    const SERVER_URL = 'https://EchoBreakStatus.pythonanywhere.com/api/status';

    const dashboard = document.getElementById('dashboard');
    const refreshTimeEl = document.getElementById('refresh-time');
    const onlineCountEl = document.getElementById('online-count');
    const xmrigCountEl = document.getElementById('xmrig-count');

    // Natural sort helper (handles alphanumeric like SM1, SM2, SM10 correctly)
    function naturalSort(a, b) {
      return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
    }

    // Custom sort: SM* first (numerically), then others (alphanumerically)
    function sortDevices(devices) {
      const entries = Object.entries(devices || {});
      const smDevices = [];
      const otherDevices = [];

      for (const [hostname, data] of entries) {
        if (hostname.startsWith('SM')) {
          smDevices.push([hostname, data]);
        } else {
          otherDevices.push([hostname, data]);
        }
      }

      smDevices.sort(([a], [b]) => naturalSort(a, b));
      otherDevices.sort(([a], [b]) => naturalSort(a, b));

      return [...smDevices, ...otherDevices];
    }

    async function fetchStatus() {
      try {
        dashboard.innerHTML = 'Обновление данных...';
        const res = await fetch(SERVER_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${await res.text()}`);

        const devices = await res.json();
        renderDevices(devices);
        refreshTimeEl.textContent = 'Последнее обновление: ' + new Date().toLocaleString('ru-RU');
      } catch (error) {
        console.error('Ошибка:', error);
        dashboard.innerHTML = `<p class="status-error">Ошибка загрузки: ${error.message}</p>`;
        onlineCountEl.textContent = '0/0';
        xmrigCountEl.textContent = '0/0';
      }
    }

    function renderDevices(devices) {
      const totalDevices = Object.keys(devices || {}).length;

      if (!devices || totalDevices === 0) {
        dashboard.innerHTML = '<p>Нет данных о статусе устройств.</p>';
        onlineCountEl.textContent = '0/0';
        xmrigCountEl.textContent = '0/0';
        return;
      }

      let content = '';
      let onlineCount = 0;
      let xmrigCount = 0;

      const sortedEntries = sortDevices(devices);

      for (const [hostname, data] of sortedEntries) {
        const displayStatus = data.status || 'N/A';
        const displayXMRig = data.xmrig_status || 'N/A';
        const displayVersion = data.version || 'неизвестно';
        const statusClass = displayStatus === 'online' ? 'status-ok' : 'status-error';
        const lastSeen = data.last_seen ?
          new Date(data.last_seen + 'Z').toLocaleString('ru-RU', {
            timeZone: 'Europe/Moscow',
            hour12: false
          }) : 'неизвестно';

        if (displayStatus === 'online') {
          onlineCount++;
        }

        if (displayXMRig === 'running') {
          xmrigCount++;
        }

        content += `
          <div class="device-box">
            <h3>${data.hostname || hostname}</h3>
            <p><strong>Статус:</strong> <span class="${statusClass}">${displayStatus}</span></p>
            <p><strong>XMRig:</strong> ${displayXMRig}</p>
            <p><strong>Версия:</strong> ${displayVersion}</p>
            <p><small>Обновлено: ${lastSeen}</small></p>
          </div>
        `;
      }

      dashboard.innerHTML = content;
      onlineCountEl.textContent = `${onlineCount}/${totalDevices}`;
      xmrigCountEl.textContent = `${xmrigCount}/${totalDevices}`;
    }

    fetchStatus();
  </script>
</body>

</html>