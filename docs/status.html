<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoBreak - Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>

  <!-- Header -->
  <header>
    <a href="index.html" id="logo-link">
      <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
    </a>
    <nav>
      <ul>
        <space></space>
        <li><a href="about.html">О нас</a></li>
        <li><a href="projects.html" class="active">Проекты</a></li>
        <li><a href="fanfics.html">Комьюнити</a></li>
        <li><a href="crypto.html">Крипта</a></li>
      </ul>
    </nav>
  </header>

  <!-- Separator Line -->
  <div class="separator"></div>

  <!-- Main Content -->
  <main>
    <h1>EchoBreak</h1>
    <h2>Device Status Dashboard</h2>
    <div id="dashboard">Загрузка устройств...</div>
  </main>

  <!-- Footer -->
  <footer>
    <p>EchoBreak, 2025</p>
  </footer>

  <script>
    const GITHUB_TOKEN = 'ghp_iFEyATUgNTdKWnja' + '0PorXZQUKu2u8P4EPxhI';
    const STALE_MINUTES = 11;
    const STALE_MS = STALE_MINUTES * 60 * 1000;

    document.addEventListener('DOMContentLoaded', async function () {
      const dashboard = document.getElementById('dashboard');
      let content = '';

      try {
        const response = await fetch('https://api.github.com/gists', {
          method: 'GET',
          headers: {
            'Authorization': `token ${GITHUB_TOKEN}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`GitHub API ошибка: ${errorData.message}`);
        }

        const gists = await response.json();

        if (gists.length === 0) {
          dashboard.textContent = 'Нет доступных Gists.';
          return;
        }

        const now = new Date();

        for (const gist of gists) {
          const files = gist.files;
          const fileNames = Object.keys(files).filter(
            name => /^status/i.test(name) && name.endsWith('.json')
          );

          for (const filename of fileNames) {
            const file = files[filename];
            const rawUrl = file.raw_url;
            const gistUpdatedAt = new Date(gist.updated_at);
            const timeDiff = now - gistUpdatedAt;
            const isStale = timeDiff > STALE_MS;

            let data = {};
            try {
              const fileRes = await fetch(rawUrl);
              if (fileRes.ok) {
                data = await fileRes.json().catch(() => ({}));
              }
            } catch (err) {
              data = {};
            }

            if (isStale && data.status !== 'offline') {
              data.status = 'offline';
              data['xmrig-status'] = 'standby';
              data.error = 'Авто: нет обновлений >11 мин';

              try {
                const patchResponse = await fetch(`https://api.github.com/gists/${gist.id}`, {
                  method: 'PATCH',
                  headers: {
                    'Authorization': `token ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    files: {
                      [filename]: {
                        content: JSON.stringify(data, null, 2)
                      }
                    }
                  })
                });

                if (patchResponse.ok) {
                  console.log(`Обновлено: ${filename} → offline (авто)`);
                } else {
                  const err = await patchResponse.json();
                  console.warn(`Не удалось обновить Gist ${gist.id}:`, err.message);
                }
              } catch (patchError) {
                console.error('Ошибка при обновлении Gist:', patchError);
              }
            }

            const displayStatus = data.status || 'N/A';
            const displayXMRig = data['xmrig-status'] || 'N/A';
            const statusClass = displayStatus === 'online' ? 'status-ok' : 'status-error';

            content += `
              <div class="device-box">
                <h3>${data.name || filename.replace('.json', '')}</h3>
                <p><strong>Статус:</strong> <span class="${statusClass}">${displayStatus}</span></p>
                <p><strong>XMRig:</strong> ${displayXMRig}</p>
                ${data.error ? `<p><strong>Ошибка:</strong> <span class="status-error">${data.error}</span></p>` : ''}
                <p><small>
                  Обновлено: ${gistUpdatedAt.toLocaleString('ru-RU')}
                  ${isStale ? ' <strong>(Автообновление в процессе)</strong>' : ''}
                </small></p>
              </div>
            `;
          }
        }

        dashboard.innerHTML = content || '<p>Нет данных о статусе устройств.</p>';

      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        dashboard.innerHTML = `<p class="status-error">Ошибка: ${error.message}</p>`;
      }
    });
  </script>
</body>

</html>