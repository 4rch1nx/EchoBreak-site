<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoBreak - Фанфики</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body>
    <!-- Header -->
    <header>
        <a href="index.html" id="logo-link">
            <img src="images/logo.png" alt="EchoBreak Logo" class="logo">
        </a>
        <nav>
            <ul>
                <space></space>
                <li><a href="about.html">О нас</a></li>
                <li><a href="projects.html">Проекты</a></li>
                <li><a href="fanfics.html" class="active">Комьюнити</a></li>
                <li><a href="crypto.html">Крипта</a></li>
            </ul>
        </nav>
    </header>
    <div class="separator"></div>
    <!-- Main Content -->
    <main>
        <h1>EchoBreak</h1>
        <h2>Фанфики</h2>
        <button type="createFanfic" class="button" onclick="window.location.href='uploadFanfic.html'">Загрузить
            фанфик</button>
        <button class="transparent-button" id="viewStarredButton">Избранные фанфики</button>
        <button class="transparent-button" id="viewStatsButton">Статистика просмотров</button>
        <div id="gistsList" class="fanfic-grid"></div>

        <!-- Modals -->
        <div id="fanficModal" class="modal">
            <div class="modal-content full-screen">
                <span class="close-modal">&times;</span>
                <div class="modal-header">
                    <div class="modal-title-container">
                        <h2 id="fanficTitle"></h2>
                        <div class="modal-actions">
                            <button id="starButton" class="star-button">☆</button>
                            <button id="viewAuthorButton" class="author-button">Автор</button>
                            <button id="toggleReadingMode" class="reading-mode-button">◐</button>
                        </div>
                    </div>
                    <p id="fanficAuthorDate"></p>
                    <p id="fanficStats"></p>
                </div>
                <hr class="modal-separator">
                <div id="fanficContent"></div>
            </div>
        </div>

        <div id="authorModal" class="modal">
            <div class="modal-content">
                <span class="close-modal author-close">&times;</span>
                <h2 id="authorName"></h2>
                <div id="authorStats"></div>
                <h3>Другие фанфики автора:</h3>
                <div id="authorFanfics" class="author-fanfics-list"></div>
            </div>
        </div>

        <div id="starredModal" class="modal">
            <div class="modal-content star">
                <span class="close-modal starred-close">&times;</span>
                <h2>Избранные фанфики</h2>
                <div id="starredFanficsList"></div>
            </div>
        </div>

        <div id="statsModal" class="modal">
            <div class="modal-content">
                <span class="close-modal stats-close">&times;</span>
                <h2>Статистика просмотров</h2>
                <div id="statsContent">
                    <div class="stats-summary">
                        <h3>Общая статистика</h3>
                        <div id="globalStats">Загрузка...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <footer>
        <p>EchoBreak, 2025</p>
    </footer>

    <script>
        const API_BASE = 'https://EchoBreakStatus.pythonanywhere.com';
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async function () {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            currentUser = localStorage.getItem('userName');
            if (!isLoggedIn || !currentUser) {
                alert('Вы не вошли в систему');
                window.location.href = 'login.html';
                return;
            }

            try {
                const resp = await fetch(`${API_BASE}/api/user-data?name=${encodeURIComponent(currentUser)}`);
                if (!resp.ok) throw new Error('Пользователь не найден');
                const { user_data: userData } = await resp.json();

                if (!userData.userToken || userData.userToken === 'rejected') {
                    alert('У вас нет доступа к фанфикам. Обратитесь к администратору.');
                    window.location.href = 'index.html';
                    return;
                }

                await loadFanfics();
                document.getElementById('viewStarredButton')?.addEventListener('click', () => loadStarredFanfics());
                document.getElementById('viewStatsButton')?.addEventListener('click', () => showStatsModal());
            } catch (err) {
                alert(`Ошибка: ${err.message}`);
                window.location.href = 'login.html';
            }
        });

        async function loadFanfics() {
            const container = document.getElementById('gistsList');
            container.innerHTML = 'Загрузка фанфиков из БД...';

            try {
                const resp = await fetch(`${API_BASE}/api/fanfics`);
                if (!resp.ok) throw new Error('Не удалось загрузить фанфики');
                const fanfics = await resp.json();
                container.innerHTML = '';

                for (const f of fanfics) {
                    const stats = await fetch(`${API_BASE}/api/fanfic-stats?gist_id=${f.id}&user_name=${currentUser}`).then(r => r.json());
                    const metaResp = await fetch(`${API_BASE}/api/fanfic-content?raw_url=${encodeURIComponent(f.raw_url)}`);
                    const { meta } = metaResp.ok ? await metaResp.json() : { meta: {} };

                    const author = meta.author || 'Неизвестен';
                    const img = meta['reference-image'] && meta['reference-image'].startsWith('data:image/')
                        ? meta['reference-image']
                        : 'images/placeholder.jpg';

                    const card = document.createElement('div');
                    card.className = 'fanfic-card';
                    card.innerHTML = `
                        <img src="${img}" alt="Обложка" class="fanfic-image" onerror="this.src='images/placeholder.jpg'">
                        <div class="fanfic-metadata">
                            <p><strong>${f.title}</strong></p>
                            <p>${author}</p>
                        </div>
                        <div class="card-actions">
                            <button class="read-button" data-id="${f.id}" data-title="${f.title}" 
                                data-raw="${f.raw_url}" data-author="${author}" data-date="${f.created_at}">
                                Читать
                            </button>
                        </div>
                    `;
                    card.querySelector('.read-button').onclick = () =>
                        loadFanficContent(f.id, f.raw_url, f.title, f.created_at, author, stats);
                    container.appendChild(card);
                }
            } catch (err) {
                container.textContent = `Ошибка: ${err.message}`;
            }
        }

        async function loadFanficContent(gistId, rawUrl, title, createdAt, author, stats) {
            try {
                await fetch(`${API_BASE}/api/fanfic-stats`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gist_id: gistId, user_name: currentUser })
                });

                const resp = await fetch(`${API_BASE}/api/fanfic-content?raw_url=${encodeURIComponent(rawUrl)}`);
                if (!resp.ok) throw new Error('Фанфик недоступен');
                const { body } = await resp.json();

                let html = '';
                const lines = body.split('\n');
                let inList = false, inOrderedList = false;

                for (let line of lines) {
                    line = line.trim();
                    if (line.startsWith('###')) {
                        html += `<h4>${line.slice(3).trim()}</h4>`;
                    } else if (line.startsWith('##')) {
                        html += `<h3>${line.slice(2).trim()}</h3>`;
                    } else if (line.startsWith('#')) {
                        html += `<h2>${line.slice(1).trim()}</h2>`;
                    } else if (line.startsWith('* ') || line.startsWith('- ')) {
                        if (!inList) { html += '<ul>'; inList = true; }
                        html += `<li>${line.slice(2).trim()}</li>`;
                    } else if (/^\d+\.\s/.test(line)) {
                        if (!inOrderedList) { html += '<ol>'; inOrderedList = true; }
                        html += `<li>${line.replace(/^\d+\.\s*/, '').trim()}</li>`;
                    } else if (line === '---' || line === '***') {
                        html += '<hr>';
                    } else if (line.startsWith('>')) {
                        html += `<blockquote>${line.slice(1).trim()}</blockquote>`;
                    } else if (line) {
                        if (inList) { html += '</ul>'; inList = false; }
                        if (inOrderedList) { html += '</ol>'; inOrderedList = false; }
                        html += `<p>${line}</p>`;
                    } else {
                        if (inList) { html += '</ul>'; inList = false; }
                        if (inOrderedList) { html += '</ol>'; inOrderedList = false; }
                        html += '<br>';
                    }
                }
                if (inList) html += '</ul>';
                if (inOrderedList) html += '</ol>';

                document.getElementById('fanficTitle').textContent = title;
                document.getElementById('fanficAuthorDate').textContent =
                    `Автор: ${author} | Дата выхода: ${new Date(createdAt).toLocaleString('ru-RU')}`;
                document.getElementById('fanficStats').textContent =
                    `${stats.views} просмотров (${stats.uniqueViews} уникальных)`;
                document.getElementById('fanficContent').innerHTML = html;

                const starBtn = document.getElementById('starButton');
                const userResp = await fetch(`${API_BASE}/api/user-data?name=${encodeURIComponent(currentUser)}`);
                const { user_data } = await userResp.json();
                const isStarred = (user_data.starredFanfics || []).includes(gistId);
                starBtn.textContent = isStarred ? '★' : '☆';
                starBtn.onclick = () => toggleStar(gistId, starBtn);

                document.getElementById('viewAuthorButton').onclick = () => viewAuthorHistory(author);

                document.getElementById('toggleReadingMode').onclick = function () {
                    const modal = document.querySelector('.modal-content.full-screen');
                    modal.classList.toggle('light-mode');
                    this.textContent = modal.classList.contains('light-mode') ? '☼' : '◐';
                };

                document.getElementById('fanficModal').style.display = 'block';
            } catch (err) {
                alert(`Ошибка: ${err.message}`);
            }
        }

        async function toggleStar(gistId, button) {
            const userResp = await fetch(`${API_BASE}/api/user-data?name=${encodeURIComponent(currentUser)}`);
            const { user_data } = await userResp.json();
            const starred = user_data.starredFanfics || [];
            const isStarred = starred.includes(gistId);

            if (isStarred) {
                starred.splice(starred.indexOf(gistId), 1);
                button.textContent = '☆';
            } else {
                starred.push(gistId);
                button.textContent = '★';
            }

            await fetch(`${API_BASE}/api/update-user-data`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: currentUser, updates: { starredFanfics: starred } })
            });
        }

        async function loadStarredFanfics() {
            const modal = document.getElementById('starredModal');
            const list = document.getElementById('starredFanficsList');
            list.innerHTML = 'Загрузка...';
            modal.style.display = 'block';

            try {
                const userResp = await fetch(`${API_BASE}/api/user-data?name=${encodeURIComponent(currentUser)}`);
                const { user_data } = await userResp.json();
                const starredIds = user_data.starredFanfics || [];

                if (starredIds.length === 0) {
                    list.innerHTML = '<p>У вас пока нет избранных фанфиков.</p>';
                    return;
                }

                const fanficsResp = await fetch(`${API_BASE}/api/fanfics`);
                const allFanfics = await fanficsResp.json();
                const starredFanfics = allFanfics.filter(f => starredIds.includes(f.id));

                list.innerHTML = '';
                for (const f of starredFanfics) {
                    const stats = await fetch(`${API_BASE}/api/fanfic-stats?gist_id=${f.id}`).then(r => r.json());
                    const metaResp = await fetch(`${API_BASE}/api/fanfic-content?raw_url=${encodeURIComponent(f.raw_url)}`);
                    const { meta } = metaResp.ok ? await metaResp.json() : { meta: {} };
                    const author = meta.author || 'Неизвестен';

                    const el = document.createElement('div');
                    el.className = 'fanfic-card starred-item';
                    el.innerHTML = `
                        <img src="${meta['reference-image'] || 'images/placeholder.jpg'}" 
                             alt="Обложка" class="fanfic-image" onerror="this.src='images/placeholder.jpg'">
                        <h4>${f.title}</h4>
                        <p>Автор: ${author}</p>
                        <p>Дата: ${new Date(f.created_at).toLocaleString('ru-RU')}</p>
                        <p>${stats.views} просмотров (${stats.uniqueViews} уникальных)</p>
                        <button class="read-button" data-id="${f.id}" data-title="${f.title}" 
                            data-raw="${f.raw_url}" data-author="${author}" data-date="${f.created_at}">Читать</button>
                        <button class="remove-star-button" data-id="${f.id}">Удалить из избранного</button>
                    `;
                    el.querySelector('.read-button').onclick = () =>
                        loadFanficContent(f.id, f.raw_url, f.title, f.created_at, author, stats);
                    el.querySelector('.remove-star-button').onclick = async () => {
                        await toggleStar(f.id, { textContent: '★' });
                        loadStarredFanfics();
                    };
                    list.appendChild(el);
                }
            } catch (err) {
                list.innerHTML = `<p>Ошибка: ${err.message}</p>`;
            }
        }

        async function viewAuthorHistory(authorName) {
            const modal = document.getElementById('authorModal');
            document.getElementById('authorName').textContent = authorName;
            const statsEl = document.getElementById('authorStats');
            const listEl = document.getElementById('authorFanfics');
            statsEl.innerHTML = 'Загрузка...';
            listEl.innerHTML = '';

            try {
                const fanficsResp = await fetch(`${API_BASE}/api/fanfics`);
                const fanfics = await fanficsResp.json();
                const authorWorks = [];

                for (const f of fanfics) {
                    const metaResp = await fetch(`${API_BASE}/api/fanfic-content?raw_url=${encodeURIComponent(f.raw_url)}`);
                    if (!metaResp.ok) continue;
                    const { meta } = await metaResp.json();
                    if (meta.author === authorName) {
                        const stats = await fetch(`${API_BASE}/api/fanfic-stats?gist_id=${f.id}`).then(r => r.json());
                        const wordCount = (await metaResp.json()).body.split(/\s+/).filter(w => w).length;
                        authorWorks.push({ ...f, meta, stats, wordCount });
                    }
                }

                const total = authorWorks.length;
                const words = authorWorks.reduce((sum, f) => sum + f.wordCount, 0);
                const views = authorWorks.reduce((sum, f) => sum + f.stats.views, 0);
                const unique = authorWorks.reduce((sum, f) => sum + f.stats.uniqueViews, 0);
                const avgWords = total ? Math.round(words / total) : 0;
                const first = authorWorks.length ? new Date(Math.min(...authorWorks.map(f => new Date(f.created_at)))).toLocaleDateString('ru-RU') : '—';

                statsEl.innerHTML = `
                    <p><strong>Фанфиков:</strong> ${total}</p>
                    <p><strong>Всего слов:</strong> ${words.toLocaleString('ru-RU')}</p>
                    <p><strong>Всего просмотров:</strong> ${views.toLocaleString('ru-RU')}</p>
                    <p><strong>Уникальных:</strong> ${unique.toLocaleString('ru-RU')}</p>
                    <p><strong>Среднее слов:</strong> ${avgWords.toLocaleString('ru-RU')}</p>
                    <p><strong>Первый фанфик:</strong> ${first}</p>
                `;

                authorWorks.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                for (const f of authorWorks) {
                    const item = document.createElement('div');
                    item.className = 'author-fanfic-item';
                    item.innerHTML = `
                        <h4>${f.title}</h4>
                        <p>${new Date(f.created_at).toLocaleDateString('ru-RU')} • ${f.wordCount.toLocaleString('ru-RU')} слов • ${f.stats.views} просмотров</p>
                        <button class="read-button-small" data-id="${f.id}" data-title="${f.title}" 
                            data-raw="${f.raw_url}" data-date="${f.created_at}">Читать</button>
                    `;
                    item.querySelector('.read-button-small').onclick = () =>
                        loadFanficContent(f.id, f.raw_url, f.title, f.created_at, authorName, f.stats);
                    listEl.appendChild(item);
                }

                modal.style.display = 'block';
            } catch (err) {
                statsEl.innerHTML = `Ошибка: ${err.message}`;
            }
        }

        async function showStatsModal() {
            const modal = document.getElementById('statsModal');
            const el = document.getElementById('globalStats');
            el.textContent = 'Загрузка...';
            modal.style.display = 'block';

            try {
                const fanficsResp = await fetch(`${API_BASE}/api/fanfics`);
                const fanfics = await fanficsResp.json();
                let totalViews = 0, totalUnique = 0, maxViews = 0, topTitle = '';

                for (const f of fanfics) {
                    const stats = await fetch(`${API_BASE}/api/fanfic-stats?gist_id=${f.id}`).then(r => r.json());
                    totalViews += stats.views;
                    totalUnique += stats.uniqueViews;
                    if (stats.views > maxViews) {
                        maxViews = stats.views;
                        topTitle = f.title;
                    }
                }

                el.innerHTML = `
                    <p><strong>Всего фанфиков:</strong> ${fanfics.length}</p>
                    <p><strong>Общие просмотры:</strong> ${totalViews.toLocaleString('ru-RU')}</p>
                    <p><strong>Уникальные читатели:</strong> ${totalUnique.toLocaleString('ru-RU')}</p>
                    <p><strong>Самый популярный:</strong> ${topTitle} (${maxViews} просмотров)</p>
                `;
            } catch (err) {
                el.textContent = `Ошибка: ${err.message}`;
            }
        }

        document.querySelectorAll('.close-modal').forEach(btn => {
            btn.onclick = () => btn.closest('.modal').style.display = 'none';
        });
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) e.target.style.display = 'none';
        };
    </script>
</body>

</html>